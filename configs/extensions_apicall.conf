; ============================================
; Contextos de Asterisk para Apicall
; ============================================
; INSTRUCCIONES:
; 1. Copiar este contenido al final de /etc/asterisk/extensions_custom.conf
; 2. Ejecutar: asterisk -rx "dialplan reload"
; ============================================

[apicall_context]
; Contexto de entrada para llamadas gestionadas por el microservicio Go
; Este contexto se ejecuta cuando AMI origina una llamada
exten => s,1,NoOp(=== Llamada gestionada por Apicall Microservicio ===)
 same => n,Set(CHANNEL(language)=es)
 same => n,Answer()
 same => n,Wait(0.5)
 ; Conectar con servidor FastAGI (pasar proyecto_id como argumento)
 same => n,AGI(agi://127.0.0.1:4573,${APICALL_PROYECTO_ID})
 same => n,NoOp(AGI terminado)
 same => n,Hangup()

[apicall_outbound]
; Contexto de salida para transferencias
; Las variables APICALL_* son establecidas por el servidor FastAGI
exten => _X.,1,NoOp(=== Transferencia Apicall: ${EXTEN} ===)
 same => n,Set(CALLERID(num)=${APICALL_CALLERID})
 same => n,NoOp(Troncal: ${APICALL_TRUNK}, Prefijo: ${APICALL_PREFIX})
 ; Marcar vía la troncal especificada
 same => n,Dial(SIP/${APICALL_TRUNK}/${APICALL_PREFIX}${EXTEN},60,tTr)
 same => n,NoOp(Disposition: ${DIALSTATUS})
 same => n,Hangup()

; ============================================
; NOTAS DE CONFIGURACIÓN:
; ============================================
; - El servidor FastAGI debe estar corriendo en puerto 4573
; - Las variables de canal se pasan desde AMI al originar la llamada
; - La troncal SIP debe existir en sip.conf o pjsip.conf
; - Ajustar timeout (60) según necesidades
; ============================================
[apicall_dialer]
; Contexto intermedio para marcar y reportar estado a la API
exten => _X.,1,NoOp(Apicall Dialing ${EXTEN} with LogID ${APICALL_LOG_ID})
 same => n,Dial(SIP/${APICALL_TRUNK}/${APICALL_PREFIX}${EXTEN},45)
; Reportar estado final a la API (si falla o cuelgan)
 same => n,Set(RES=${CURL(http://localhost:8080/api/v1/logs/status?id=${APICALL_LOG_ID}&status=${DIALSTATUS})})
 same => n,Hangup()
